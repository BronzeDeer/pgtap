<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <!-- this template was designed by http://www.tristarwebdesign.co.uk - please visit for more templates & information - thank you. -->
  <head>
    <meta http-equiv="Content-Language" content="en-us" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf8" />
    <title>pgTAP: Integration</title>
    <link rel="stylesheet" type="text/css" href="/ui/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/ui/css/menu.css" />
    <!--[if IE 6]>
      <link rel="stylesheet" type="text/css" href="/ui/css/ie.css" />
    <![endif]-->
  </head>

  <body>
    <div id="main">

      <h1>pgTAP Integration</h1>

      <p>So you've caught the database testing bug and now you want to
      integrate pgTAP tests into your project's test suite. Excellent. You've
      come to the right place. Just find your favorite programming language
      below and follow along. Don't see your language here yet? If you figure
      out how to do it, please send us the instructions!</p>

      <ul>
        <li><a href="#perl" title="pgTAP Perl Integration">Perl</a></li>
        <li><a href="#php" title="pgTAP Php Integration">PHP</a></li>
        <li><a href="#python" title="pgTAP Python Integration">Python</a></li>
        <li><a href="#postgresql" title="pgTAP Postgresql Integration">PostgreSQL</a></li>
      </ul>

      <h2 id="perl">Perl</h2>

      <p>Chances are, if you're writing Perl applications, you're already using
        <a href="http://search.cpan.org/perldoc/Test::More" title="Test::More
        on CPAN">Test::More</a>
        and <a href="http://search.cpan.org/perldoc/Test::More"
        title="Test::Harness on CPAN">Test::Harness</a> to write and run your
        tests. If you
        use <a href="http://search.cpan.org/perldoc/Module::Build"
        title="Test::More on CPAN">Module::Build</a> to build your
        application, here's how to hook in pgTAP tests so that they run right
        along with your Perl tests.</p>

      <h3>Requirements</h3>
      <ul>
        <li><a href="http://search.cpan.org/perldoc/Module::Build"
        title="Test::More on CPAN">Module::Build</a> 0.2808_02 or later</li>
        <li><a href="http://search.cpan.org/perldoc/TAP::Harness"
        title="Test::More on CPAN">TAP::Harness</a> 3.12 or later</li>
      </ul>

      <h3>Instructions</h3>
      <ul>
        <li>
          <p>Put your tests in the <code>t/</code> directory of your project,
            just like the Perl tests. Give them a suffix of “.s”, leaving your
            Perl tests with a suffix of “.t”. You don't need to set any
            special variables in the test scripts. They can be as simple as
            this:</p>

          <pre><code>BEGIN;
SELECT plan( 1 );
SELECT pass('W00t!');
SELECT * FROM finish();
ROLLBACK;</code></pre>
        </li>

        <li>
          <p>In <code>Build.PL</code>, subclass Module::Build like so:</p>

          <pre><code>my $class = Module::Build->subclass(code => <<'EOF');
sub tap_harness_args {
    return {
        exec => sub {
            my ( $harness, $test_file ) = @_;
            # Let Perl tests run.
            return undef if $test_file =~ /[.]t$/;
            # Run pgTAP tests through psql.
            return [qw(
                psql
                --username postgres
                --database try
                --quiet
                --no-psqlrc
                --no-align
                --tuples-only
                --set ON_ERROR_ROLLBACK=1
                --set ON_ERROR_STOP=1
                --file
            ), $test_file ] if $test_file =~ /[.]s$/;
        },
    };
}
EOF
$class->new(
   # ...
)->create_build_script;
</code></pre>

          <p>What this does is tell Module::Build to use TAP::Harness to run
          tests, rather than Test::Harness, and it tells it to use <code>psql</code> to run
          tests with file names ending in “.s”.</p>
        </li>
        <li>
          <p>Tweak this as necessary to match your configuration. For example,
          the database you connect to may not be “try”, and the user may not
          be “postgres”. You might also need to specify a host name and port;
          consult
          the <a href="http://www.postgresql.org/docs/current/static/app-psql.html"
          title="psql documentation"><code>psql</code> documentation</a> to
          decide what other options you might need to specify. And of course,
          you should fill in the proper parameters to <code>new()</code> (you
          probably already have them).</p>
        </li>

        <li>
          <p>Now you can run your tests as usual:</p>

          <pre><code> ./Build test                                            
t/perl.t......ok   
t/pgtap.s.....ok   
All tests successful.
Files=2, Tests=6,  0 wallclock secs ( 0.03 usr  0.01 sys +  0.03 cusr  0.02 csys =  0.09 CPU)
Result: PASS</code></pre>

          <p>If you see a bunch of “NOTICE” messages output from PostgreSQL,
          likely because your test is creating tables, you can either
          add <code>client_min_messages = warning</code> to your
          <code>postgresql.conf</code> file and restart PostgreSQL
          (recommended), or just add
          <code>SET client_min_messages = warning;</code>
          to the top of your pgTAP test scripts.</p>
        </li>
        <li><p>Profit. Have fun!</p></li>
      </ul>

      <p>Support for running pgTAP tests
        with <a href="http://search.cpan.org/perldoc/ExtUtils::MakeMaker"
        title="ExtUtils::MakeMaker on CPAN">ExtUtils::MakeMaker</a> is
        planned, as well. Just bug Schwern to commit the patch and release a
        new version!</p>

      <h2 id="php">PHP</h2>

      <p>We're sure there's a way to integrate pgTAP tests
      with <a href="http://www.phpunit.de/" title="PHPUnit project page">PHPUnit</a>
      or <a href="http://code.google.com/p/snaptest/" title="SnapTest project on Google Code">SnapTest</a>. If you figure it out, please send the
      instructions to
      the <a href="http://lists.pgfoundry.org/mailman/listinfo/pgtap-users"
      title="Subscribe to pgtap-users">pgtap-users</a> mail list and we'll add
      them to this page!</p>

      <h2 id="python">Python</h2>

      <p>We're sure there's a way to integrate pgTAP tests
      with <a href="http://pyunit.sourceforge.net/"
      title="PyUnit - the standard unit testing framework for Python">PyUnit</a>.
      Certainly
      with <a href="http://git.codesimply.com/?p=PyTAP.git;a=summary/"
      title="PyTAP - TAP-emitting testing for Python">PyTAP</a>. If you figure
      it out, please send the instructions to
      the <a href="http://lists.pgfoundry.org/mailman/listinfo/pgtap-users"
      title="Subscribe to pgtap-users">pgtap-users</a> mail list and we'll add
      them to this page!</p>

      <h2 id="postgresql">PostgreSQL</h2>
      <p>If you're developing an add-on module for PostgreSQL, it can be very
      useful to do test-driven development with pgTAP
      and <code>pg_prove</code>. But once things are working, it's also handy
      to allow such tests to be run via <code>make installcheck</code>, which
      uses <code>pg_regress</code> to run tests and to <code>diff</code> their
      output to that found in expected output files. So here's how to do that
      with pgTAP while keeping everything TAPish.</p>

      <h3>Instructions</h3>
      <ul>
        <li>
          <p>Copy <code>pgtap.sql</code> to the root of your project, so that
          it can be loaded by the regression tests.</p>
        </li>
        <li>
          <p>Comment-out the declaration of the <code>pg_typeof()</code>
          function in this bundled copy <code>pgtap.sql</code>. Unfortunately,
          this function is not (yet) included with PostgreSQL, and since it is
          defined for pgTAP in C, you can't use it in an uninstalled copy of
          pgTAP distributed with your module. Regrettably, this means that you
          have to avoid <code>cmp_ok()</code> in your tests as well, as this
          otherwise very useful test function relies on
          <code>pg_typeof()</code>. This issue hass been addressed in
          PostgreSQL 8.4.</p>
        </li>
        <li>
          <p>Add these lines to the <code>Makefile</code>:</p>

          <pre>TESTS = $(wildcard sql/*.sql)
REGRESS = $(patsubst sql/%.sql,%,$(TESTS))
REGRESS_OPTS = --load-language plpgsql</pre>

          <p>The first two lines are an easy way to find all of your test
          files, which should all be <code>*.sql</code> files in
          the <code>sql/</code> directory. The <code>REGRESS_OPTS</code>
          variable ensures that PL/pgSQL will be loaded in the test database,
          which is of course required by pgTAP.</p>

          <p>If you want to allow a <code>make test</code> target that uses
            <code>pg_prove</code> to run the tests, you can do so by adding
            the following to the <code>Makefile</code>:</p>

          <pre>test:
	./bin/pg_prove --pset tuples_only=1 $(TESTS)</pre>

          <p>If you're not familiar with how PostgreSQL module Makefiles are
            constructed, it's actually quite simple to create a portable build
            system using <code>pg_config</code> and <code>pg_xs</code>. See
            the <a href="http://www.postgresql.org/docs/current/static/xfunc-c.html#XFUNC-C-PGXS"
            title="PostgreSQL Extension Building Infrastructure">extension
            building documentation</a> for details and the
            simple <code>Makefile</code> in the
            <a href="http://www.postgresql.org/docs/current/static/textsearch-parser-example.html"
            title="PostgreSQL: Example of Creating a Parser">parser
            example</a> in the PostgreSQL documentation.</p>
        </li>
        <li>
          <p>In the root directory of your project, create a new file,
          named <code>test_setup.sql</code>. Its contents should look like
          this:</p>

          <pre>\set QUIET 1

-- Format the output for nice TAP.
\pset format unaligned
\pset tuples_only true
\pset pager

-- Revert all changes on failure.
\set ON_ERROR_ROLLBACK 1
\set ON_ERROR_STOP true

-- Load the TAP functions.
BEGIN;
\i pgtap.sql</pre>

          <p>These are all of the settings that are normally handled
          by <code>pg_prove</code>, but not by <code>pg_regress</code>, so we
          have to add them ourselves.</p>
        </li>
        <li>
          <p>Each of your test files, <code>sql/*.sql</code> should look like
          so:</p>

          <pre>\unset ECHO
\i test_setup.sql

SELECT plan(1);
SELECT pass('W00t!');
SELECT * FROM finish();
ROLLBACK;</pre>

          <p>The <code>\unset ECHO</code> bit turns off the echoing of all
          queries, which <code>pg_regress</code> enables by default. This is
          annoying for TAP tests. Otherwise, all the tests do is load
          the <code>test_setup.sql</code> file, which makes everything nice
          and quiet and pretty for TAP, starts the transaction, and loads
          pgTAP, and the do the actual testing. Be sure
          to <code>finish()</code> and <code>ROLLBACK</code> at the end of the
          test!</p>
        </li>
        <li>
          <p>For each test file in the <code>sql/</code> directory, create a
          corresponding file in the <code>expected</code> directory with the
          same name as the test file, but with the extension “.out”. These
          files should just have the line <code>\unset ECHO</code> at the top,
          and then the TAP output from the test. For example, if the above
          test had been named <code>sql/base.sql</code>, you'd create the
          file <code>expected/base.out</code> looking like this:</p>

          <pre>\unset ECHO
1..1
ok 1 - W00t!
</pre>

          <p>Alas, there seems to be no way to get rid of the <code>\unset
          ECHO</code> line, but otherwise, you're golden with pure TAP.</p>
        </li>
        <li>
          <p>And now you should be ready to go! You should be able to either
            <code>make installcheck</code> as with any other PostgreSQL
            module, as well as <code>make test</code>. Enjoy!</p>
        </li>
      </ul>

    </div>
    <div id="menu">
      <div id="menutop">
        <a title="pgTAP home" href="/"><img alt="home" src="/ui/img/tap.jpg" width="200" alt="tap" /></a>
      </div>

      <div class="navcontainer">
        <ul class="navlist">
          <li><a title="pgTAP home" href="/">Home</a></li>
          <li><a title="Download pgTAP from pgFoundry" href="http://pgfoundry.org/frs/?group_id=1000389">Download</a></li>
          <li><a title="Read the complete pgTAP documentation" href="/documentation.html">Documentation</a></li>
          <li><a title="Read the documenaton for pg_prove" href="/pg_prove.html">pg_prove</a></li>
          <li><a title="Integrate pgTAP into your test suite" href="/integration.html" id="selected">Integration</a></li>
          <li><a title="Subscribe to the pgTAP Mail Lists" href="http://pgfoundry.org/mail/?group_id=1000389">Mail Lists</a></li>
          <li><a title="pgTAP Project Tree" href="http://github.com/theory/pgtap/tree/master/">GitHub</a></li>
        </ul>
      </div>

      <br />

      <div class="navcontainer">
        <ul class="navlist">
          <li><a title="Just a Theory" href="http://justatheory.com/">Code: David E. Wheeler</a></li>
          <li><a title="derby web design" href="http://www.tristarwebdesign.co.uk">Webdesign: tri-star</a></li>
          <li><a title="Courtland Whited's Flickr Photostream" href="http://flickr.com/photos/idreaminir/">Photo: Courtland Whited</a></li>
        </ul>
      </div>
    </div>

  </body>
</html>
